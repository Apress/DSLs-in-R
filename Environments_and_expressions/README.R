## ---- echo=FALSE---------------------------------------------------------
suppressPackageStartupMessages(library(rlang, quietly = TRUE))

## ------------------------------------------------------------------------
library(rlang)

## ------------------------------------------------------------------------
x <- 1
f <- function(y) {
  z <- 3
  function() x + y + z
}
g <- f(2)
h <- f(3)
g()
h()

## ------------------------------------------------------------------------
environment(f)

## ------------------------------------------------------------------------
environment(g)
environment(h)

## ------------------------------------------------------------------------
f <- function(x, y) x
f(2, stop("error!"))

## ------------------------------------------------------------------------
f <- function(y, z = 2 * y) y + z

## ------------------------------------------------------------------------
f(2, 1)

## ------------------------------------------------------------------------
f(2)

## ------------------------------------------------------------------------
y <- 2
f(2 * y)

## ------------------------------------------------------------------------
g <- function(x) f(2 * x)
g(2 * y)

## ------------------------------------------------------------------------
h <- function(x, y = 2 * w) {
  w <- 2
  x + y
}
h(1)

## ------------------------------------------------------------------------
h <- function(x, y = 2 * w) {
  res <- x + y
  w <- 2
  res
}
h(1)

## ------------------------------------------------------------------------
h <- function(x, y = 2 * w) {
  w <- 1
  res <- x + y
  w <- 2
  res
}
h(1)

## ------------------------------------------------------------------------
make_adder <- function(n) function(m) n + m

## ------------------------------------------------------------------------
add_1 <- make_adder(1)
add_2 <- make_adder(2)
add_1(1)
add_2(1)

## ------------------------------------------------------------------------
adders <- vector("list", 3)
for (i in 1:3) adders[[i]] <- make_adder(i)

## ------------------------------------------------------------------------
adders[[1]](1)

## ------------------------------------------------------------------------
i <- 1
adders[[1]](1)

## ------------------------------------------------------------------------
adders[[2]](1)

## ------------------------------------------------------------------------
make_adder <- function(n) {
  force(n)
  function(m) n + m
}
for (i in 1:3) adders[[i]] <- make_adder(i)
for (i in 1:3) print(adders[[i]](0))

## ------------------------------------------------------------------------
ex1 <- quote(2 * x + y)
ex1
f <- function(ex) substitute(ex)
ex2 <- f(2 * x + y)
ex2

## ------------------------------------------------------------------------
g <- rlang::new_function(alist(x=, y=), body = ex1)
g
g(1,3)

## ------------------------------------------------------------------------
x <- 1
y <- 3
eval(ex1)

## ------------------------------------------------------------------------
h <- function(x, y) eval(ex1)
h
h(1,3)

## ------------------------------------------------------------------------
h <- function(x, y) eval(ex1, rlang::caller_env())
x <- y <- 1
h(4,4)

## ------------------------------------------------------------------------
f <- function(x) rlang::new_function(alist(y=), ex1)
f(2)
f(2)(2)

## ------------------------------------------------------------------------
g <- function(x) {
  rlang::new_function(alist(y=), ex1, rlang::caller_env())
}
g(2)
g(2)(2)

## ------------------------------------------------------------------------
eval(ex1, list(x = 4, y = 8))
df <- data.frame(x = 1:4, y = 1:4)
eval(ex1, df)

## ------------------------------------------------------------------------
f <- function(expr, data, y) eval(expr, data)
g <- function(expr, data, y) eval(expr, data, rlang::caller_env())

## ------------------------------------------------------------------------
df <- data.frame(x = 1:4)
y <- 1:4
f(quote(x + y), df, y = 5:8) == 1:4 + 5:8
g(quote(x + y), df, y = 5:8) == 1:4 + 1:4

## ------------------------------------------------------------------------
f <- function(expr, data) eval(expr, data, rlang::caller_env())
f(quote(u + v), data.frame(u = 1:4, v = 1:4))

## ------------------------------------------------------------------------
fq <- function(expr, data) {
  eval(substitute(expr), data, rlang::caller_env())
}
fq(u + v, data.frame(u = 1:4, v = 1:4))

## ------------------------------------------------------------------------
g <- function(expr) fq(expr, data.frame(u = 1:4, v = 1:4))
g(u + v)

## ------------------------------------------------------------------------
u <- v <- 5:8
g(u + v)

## ------------------------------------------------------------------------
g <- function(expr) {
  fq(substitute(expr), data.frame(u = 1:4, v = 1:4))
}
g(u + v)

## ------------------------------------------------------------------------
g <- function(expr) {
  fq(quote(expr), data.frame(u = 1:4, v = 1:4))
}
g(u + v)

## ------------------------------------------------------------------------
g <- function(expr) {
  f(substitute(expr), data.frame(u = 1:4, v = 1:4))
}
g(u + v)

## ------------------------------------------------------------------------
f <- function(expr, data) eval(expr, data, rlang::caller_env())
fq <- function(expr, data) f(substitute(expr), data)
fq(u + v, data.frame(u = 1:4, v = 1:4))

## ------------------------------------------------------------------------
g <- function(x, y, z) {
  w <- x + y + z
  f(quote(w + u + v), data.frame(u = 1:4, v = 1:4))
}
h <- function(x, y, z) {
  w <- x + y + z
  fq(w + u + v, data.frame(u = 1:4, v = 1:4))
}

## ------------------------------------------------------------------------
g(1:4, 1:4, 1:4) == (1:4 + 1:4 + 1:4) + 1:4 + 1:4
h(1:4, 1:4, 1:4) == (1:4 + 1:4 + 1:4) + 1:4 + 1:4

## ------------------------------------------------------------------------
ff <- function(expr, data) {
  eval(expr[[2]], data, environment(expr))
}
ffq <- function(expr, data) {
  expr <- eval(substitute(~ expr))
  environment(expr) <- rlang::caller_env()
  ff(expr, data)
}

## ------------------------------------------------------------------------
g <- function(x, y, z) {
  w <- x + y + z
  ff(~ w + u + v, data.frame(u = 1:4, v = 1:4))
}
h <- function(x, y, z) {
  w <- x + y + z
  ffq(w + u + v, data.frame(u = 1:4, v = 1:4))
}

## ------------------------------------------------------------------------
g(1:4, 1:4, 1:4) == (1:4 + 1:4 + 1:4) + 1:4 + 1:4
h(1:4, 1:4, 1:4) == (1:4 + 1:4 + 1:4) + 1:4 + 1:4

